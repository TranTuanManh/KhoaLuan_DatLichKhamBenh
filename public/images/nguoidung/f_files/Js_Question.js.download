/**
 * Xử lý Js về ngân hàng câu hỏi
 *
 * @author Manhit
 */

function Js_Question(baseUrl,module,controller){
  this.module = module;
  this.baseUrl = baseUrl;
  $( "#main_questions" ).attr( "class","active" );
  this.controller = controller;
  this.loadding = EfyLib.loadding();
  this.urlPath = baseUrl + '/' + module + '/' + controller;//Biên public lưu tên module
}

/**
 * Hàm load các sử kiện cho màn hình index
 *
 * @return void
 */
Js_Question.prototype.loadIndex = function(){

  $(document).ajaxSend(function () {
    EfyLib.showmainloadding();
  });
  $(document).ajaxStop(function () {
      EfyLib.successLoadImage();
  });
  var myClass = this;
  var oForm = 'form#frmQuestion_index';
  myClass.loadList();
  $(oForm).find('#btn_search').click(function(){
    myClass.loadList();
  });
  $(oForm).find('#btn_add').click(function(){
    myClass.add(oForm);
  });
  $(oForm).find('#btn_edit').click(function(){
    myClass.edit(oForm);
  });
  $(oForm).find('#btn_delete').confirmation({
    rootSelector: '[data-toggle=confirmation]',
    onConfirm: function() {
      myClass.delete(oForm);
    }
  });
  $(oForm).find('#subject,#contest_formality,#contest_group').change(function() {
    myClass.loadList();
  });
  $('.chzn-select').chosen({ width: '100%' });
  myClass.addShortcut();
}

/**
 * Hàm load các sử kiện cho màn hình khác
 *
 * @param oForm (tên form)
 *
 * @return void
 */
Js_Question.prototype.loadevent = function(){
  var myClass = this;
}

/**
 * Hàm thiet lap lai cac su kien khi quay tro ve man hinh chinh
 *
 * @param oForm (tên form)
 *
 * @return void
 */
Js_Question.prototype.backIndex = function(){
  var myClass = this;
  shortcut.remove("Enter");
  myClass.loadList();
  myClass.addShortcut();
}
Js_Question.prototype.addShortcut = function(){
  var myClass = this;
  shortcut.add("Enter",function() {
    myClass.loadList();
  });
}


Js_Question.prototype.loadList = function(oForm){
//  var loadding = EfyLib.loadding();
 // loadding.go(20);
  var myClass = this;
  var url = myClass.urlPath + '/loadList';
  var oForm = 'form#frmQuestion_index';
  var currentPage = $(oForm).find('#_currentPage').val();
  currentPage = (!currentPage) ? 1 : currentPage;
  var perPage = $(oForm).find('#cbo_nuber_record_page').val();
  perPage     = (!perPage) ? 15 : perPage;

  var data = $(oForm).serialize();
  data +='&currentPage=' + currentPage;
  data +='&perPage=' + perPage;
  $.ajax({
      url: url,
      type: "POST",
      dataType: 'json',
      //cache: true,
      data:data,
      success: function(arrResult){
        // arrResult = $.parseJSON(arrResult);
        var $html = '', data;
        data = arrResult.Dataloadlist;
        if(data) {
          for(x in data) {
            $html += '<tr>';
            $html += '<td align="center"><input ondblclick="" onclick="{select_checkbox_row(this);}" name="chk_item_id" value="' + data[x].id + '" type="checkbox"></td>';
            $html += '<td class="data" ondblclick="" onclick="{select_row(this);}" align="center">' + data[x].question_code + '</td>';
            $html += '<td class="data" ondblclick="" onclick="{select_row(this);}" align="center">' + data[x].question_content + '</td>';
            $html += '<td class="data" ondblclick="" onclick="{select_row(this);}" align="center">' + data[x].contest_formality + '</td>';
            $html += '<td class="data" ondblclick="" onclick="{select_row(this);}" align="center">' + data[x].contest_group + '</td>';
            $html += '<td class="data" ondblclick="" onclick="{select_row(this);}" align="center">' + data[x].subject + '</td>';
            $html += '<td class="data" ondblclick="" onclick="{select_row(this);}" align="center">' + data[x].level + '</td>';
            $html += '<td class="data" ondblclick="" onclick="{select_row(this);}" align="center">' + data[x].answer_type + '</td>';
            $html += '<td class="data" ondblclick="" onclick="{select_row(this);}" align="left">';
            for(y in data[x].answer){
              $html += data[x].answer[y]['answer_code'] +'. ' + data[x].answer[y]['answer_content'] + '<br>';
            }
            $html += '</td>';
            $html += '<td class="data" ondblclick="" onclick="{select_row(this);}" align="left">';
            for(y in data[x].answer){
              if(data[x].answer[y]['is_true'] == 1){
                $html += data[x].answer[y]['answer_code'] +'. ' + data[x].answer[y]['answer_content'] + '<br>';
              }
            }
            $html += '</td>';
            $html += '</tr>';
          }
        }
        $('#table-data tbody').html($html);
        $('#pagination').html(arrResult.pagination);
        $(oForm).find('.main_paginate .pagination a').click(function(){
          $(oForm).find('#_currentPage').val($(this).attr('page'));
          myClass.loadList();
        });
        $(oForm).find('#cbo_nuber_record_page').change(function(){
          myClass.loadList();
        });
        $(oForm).find('#cbo_nuber_record_page').val(arrResult.perPage);
      }
  });
}

Js_Question.prototype.add = function (oForm) {
  var myClass = this;
  var url = this.urlPath + '/add';
  var data = $(oForm).serialize();
  $.ajax({
      url: url,
      type: "POST",
      data:data,
      success: function(arrResult){
         $('#addQuestionModal').html(arrResult);
         $('#addQuestionModal').modal('show');
         $('#btn_save').hide();
         myClass.loadevent();
         // myClass.validateAddForm($('#frmAddQuestion'));
      }
  });
}